<!DOCTYPE html>

<html>
    <head>
        <title>AI</title>
    
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.js"></script>
    </head>

    <body>
        <select id="models">
            <optgroup label="Text Generators">
                <option>ChatGPT</option>
                <option>Claude</option>
                <option>DeepSeek</option>
            </optgroup>
    
            <optgroup label="Image Generators">
                <option>Stable Diffusion</option>
            </optgroup>
        </select>
    
        <input id="prompt" type="text" placeholder="Put your prompt here...">
        <input id="files" type="file" multiple>
    
        <button id="submit">SUBMIT!</button>
    
        <div id="response"></div>
    
        <script>
            const textDecoder = new TextDecoder();
    
            alert("Only ChatGPT works for now. Claude, DeepSeek and image generation will be added soon.");
            alert("If it doesn't work, just press submit again. If it continues to not do anything, view the response details in the Network tab.");
    
            function sleep(milliseconds) {
                return new Promise(resolve => setTimeout(resolve, milliseconds));
            }
    
            function newGUID() {
                return URL.createObjectURL(new Blob).match(/[a-z0-9-]+$/)?.[0];
            }
    
            function upload(file) {
                const formData = new FormData();
                formData.append('c', file);
                formData.append('e', '1m');
    
                return fetch('https://pb.angelrose.org/', {
                    method: 'POST',
                    body: formData,
                })
                    .then(response => response.json())
                    .then(data => data.suggestUrl)
            }
    
            const models = document.getElementById("models");
            const promptInput = document.getElementById("prompt");
            const fileInput = document.getElementById("files");
            const submitButton = document.getElementById("submit");
            const responseField = document.getElementById("response");
    
            // Handle dropped files
            document.addEventListener("dragover", input => input.preventDefault());
            document.addEventListener("drop", input => {
                input.preventDefault();
                
                const newFiles = Array.from(input.dataTransfer.files);
                const originalFiles = Array.from(fileInput.files)
                const files = originalFiles.concat(newFiles);
    
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
    
                fileInput.files = dataTransfer.files;
            });
    
            // Handle pasted files
            document.addEventListener("paste", input => {
                const newFiles = Array.from(input.clipboardData.items)
                    .filter(item => item.kind === 'file')
                    .map(item => item.getAsFile());
    
                const originalFiles = Array.from(fileInput.files)
                const files = originalFiles.concat(newFiles);
                
                const dataTransfer = new DataTransfer();
                files.forEach(file => dataTransfer.items.add(file));
    
                fileInput.files = dataTransfer.files;
            });
    
            models.addEventListener("change", () => {
                const option = models.options[models.selectedIndex];
                const optgroup = option.parentElement;
    
                fileInput.hidden = optgroup.label === "Image Generators";
            });
    
            submitButton.addEventListener("click", async () => {
                let ID = newGUID();
    
                responseField.innerHTML = "Loading...";
    
                // Turnstile
                const turnstile = await fetch("https://gpt4vnet.erweima.ai/api/v1/chat/should-check-turnstile", {
                    "headers": {
                        "uniqueid": ID
                    }
                })
                    .then(response => response.json())
    
                if (turnstile.code !== 200) {
                    alert("Turnstile check failed. After being redirected, please interact with the AI and then come back to this website.");
                    window.location.href = "https://www.gpt4v.net";
                    return;
                }
    
                const option = models.options[models.selectedIndex];
                const optgroup = option.parentElement;
                const prompt = promptInput.value;
                const files = fileInput.files;
    
                switch (optgroup.label) {
                    case "Text Generators": {
                        let attachments = [];
    
                        for (const file of files) {
                            attachments.push({
                                fileType: file.type,
                                fileContent: await upload(file),
                            });
                        }
    
                        const response = await fetch("https://gpt4vnet.erweima.ai/api/v1/chat/gpt4o/chat", {
                            method: "POST",
                            headers: {
                                "content-type": "application/json",
                                "uniqueid": ID,
                            },
                            body: JSON.stringify({
                                prompt,
                                sessionId: newGUID(),
                                attachments
                            })
                        });
    
                        const reader = response.body.getReader();
                        responseField.innerHTML = "";
    
                        let text = "";
    
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
    
                            const chunk = textDecoder.decode(value, { stream: true });
    
                            try {
                                const data = JSON.parse(chunk)?.data;
    
                                switch (data?.message_type) {
                                    case "text": {
                                        text += data.message;
    
                                        responseField.innerHTML = marked.parse(text);
    
                                        await MathJax.typesetPromise();
                                        break;
                                    }
    
                                    case "title_generation": {
                                        document.title = data.message;
                                        break;
                                    }
                                }
                            } catch {}
                        }
    
                        break;
                    }
                }
            });
        </script>
    </body>
</html>
